<Project Sdk="Microsoft.NET.Sdk.Razor">
  <PropertyGroup>
    <Title>Umbraco CMS - Static assets</Title>
    <Description>Contains the static assets needed to run Umbraco CMS.</Description>
    <AddRazorSupportForMvc>true</AddRazorSupportForMvc>
    <StaticWebAssetBasePath>/</StaticWebAssetBasePath>
    <EnableDefaultContentItems>false</EnableDefaultContentItems>
  </PropertyGroup>

  <ItemGroup>
    <FrameworkReference Include="Microsoft.AspNetCore.App" />
    <SupportedPlatform Include="browser" />
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="..\Umbraco.Web.BackOffice\Umbraco.Web.BackOffice.csproj" />
    <ProjectReference Include="..\Umbraco.Web.Website\Umbraco.Web.Website.csproj" />
  </ItemGroup>

  <ItemGroup>
    <Content Include="umbraco\**" />
    <Content Include="wwwroot\**" />
  </ItemGroup>

  <!-- Build client assets using NPM -->
  <ItemGroup>
    <ClientAssetsInputs Include="assets\**;gulp\**;lib\**;src\**;test\**" Exclude="$(DefaultItemExcludes)" />
  </ItemGroup>

  <Target Name="ClientAssetsRestore" BeforeTargets="DispatchToInnerBuilds" Inputs="package.json;package-lock.json" Outputs="node_modules\.package-lock.json">
    <Message Text="Restoring NPM packages" Importance="high" />
    <Exec Command="npm ci --no-fund --no-audit --prefer-offline" />
  </Target>

  <Target Name="ClientAssetsBuild" DependsOnTargets="ClientAssetsRestore" BeforeTargets="AssignTargetPaths" Inputs="@(ClientAssetsInputs)" Outputs="$(IntermediateOutputPath)clientassetsbuild.complete.txt">
    <Message Text="Executing NPM build script" Importance="High" />
    <PropertyGroup>
      <_ClientAssetsOutputFullPath>$([System.IO.Path]::GetFullPath('$(IntermediateOutputPath)clientassets'))</_ClientAssetsOutputFullPath>
      <_ClientAssetsOutputFile>$(IntermediateOutputPath)clientassets.build.txt</_ClientAssetsOutputFile>
    </PropertyGroup>
    <MakeDir Directories="$(_ClientAssetsOutputFullPath)" />
    <Exec Command="npm run build:skip-tests -- --no-color --output-path=&quot;$(_ClientAssetsOutputFullPath)&quot;" />
    <ItemGroup>
      <_ClientAssetsBuildOutput Include="$(IntermediateOutputPath)clientassets\**"></_ClientAssetsBuildOutput>
    </ItemGroup>
    <WriteLinesToFile File="$(_ClientAssetsOutputFile)" Lines="@(_ClientAssetsBuildOutput)" Overwrite="true" />
  </Target>

  <Target Name="ClientAssetsBuildOutputPath" AfterTargets="ClientAssetsBuild">
    <WriteLinesToFile File="gulpfile.outputPath.js" Lines="exports.outputPath = '$(IntermediateOutputPath.Replace('\', '/'))clientassets';" Overwrite="true" />
  </Target>

  <Target Name="DefineClientAssets" AfterTargets="ClientAssetsBuild" DependsOnTargets="ResolveStaticWebAssetsConfiguration">
    <ItemGroup>
      <FileWrites Include="@(_ClientAssetsBuildOutput)" />
      <FileWrites Include="$(_ClientAssetsOutputFile)" />
    </ItemGroup>
    <DefineStaticWebAssets CandidateAssets="@(_ClientAssetsBuildOutput)" SourceId="$(PackageId)" SourceType="Computed" ContentRoot="$(_ClientAssetsOutputFullPath)" BasePath="$(StaticWebAssetBasePath)">
      <Output TaskParameter="Assets" ItemName="StaticWebAsset" />
    </DefineStaticWebAssets>
  </Target>
</Project>
